## Zookeeper

### 定义

> zookeeper是一个分布式服务框架，是Apache Hadoop 的一个子项目，它主要是用来解决分布式应用中经常遇到的一些数据管理问题，如：统一命名服务、状态同步服务、集群管理、分布式应用配置项的管理等。

简单来说**zookeeper=文件系统+监听通知机制**

### 文件系统

[Zookeeper入门看这篇就够了](https://www.jianshu.com/p/50becf121c66)

Zookeeper维护一个类似文件系统的数据结构：

![1562673085160](d:/resource/notePic/1562673085160.png)

每个子目录项如 NameService 都被称作为 znode(目录节点)，和文件系统一样，我们能够自由的增加、删除znode，在一个znode下增加、删除子znode，唯一的不同在于znode是可以存储数据的。存储数据一般是字符串, 即一个节点上可以存一个字符串

### 节点类型

zookeeper有**4种节点类型:**

- PERSISTENT-持久化目录节点：客户端与zookeeper断开连接后，该节点依旧存在

- PERSISTENT_SEQUENTIAL-持久化顺序编号目录节点：客户端与zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号

- EPHEMERAL-临时目录节点：客户端与zookeeper断开连接后，该节点被删除

- EPHEMERAL_SEQUENTIAL-临时顺序编号目录节点：客户端与zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号

### 监听通知机制

客户端注册监听它关心的目录节点，当目录节点发生变化（数据改变、被删除、子目录节点增加删除）时，zookeeper会通知客户端, 并调用监听回调函数执行相应逻辑. 

正是基于监听通知机制, zookeeper功能非常强大，可以实现诸如**分布式应用配置管理**、作为**dubbo(rpc框架)的注册中心**、**分布式锁**、统一命名服务、状态同步服务、集群管理等功能，我们这里拿比较简单的分布式应用配置管理为例来说明。

### 基于zookeeper的分布式锁

[七张图彻底讲清楚ZooKeeper分布式锁的实现原理](https://juejin.im/post/5c01532ef265da61362232ed)

Curator框架就是基于zookeeper实现分布式锁，其主要原理：在zookeeper上创建一个**永久的锁节点**LockNode1，线程1若要竞争锁，则会在LockNode1**下创建一个临时顺序节点**，创建完后会对LockNode1下所有的临时顺序节点进行排序，如果线程1所属的临时顺序节点是最前的，那么线程1就获得锁；如果不是，则在线程1临时顺序节点前的节点上注册一个监听器，只要这个被监听的节点触发了监听事件（被监听节点被删除时触发），表明线程1此时可以获取锁了，线程1就会重新判断是否能够获取锁。基于zookeeper实现分布式锁的好处：监听机制自动通知；持有锁的节点宕机临时节点会自动删除，不存在锁不能释放的问题



